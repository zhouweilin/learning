<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>mlib-test</title>
    <link rel="stylesheet" href="./css/animate.min.css">
    <style>
        *{padding:0;margin:0;}
        div{text-align:center;font-size:50px;}
        .content{height:500px;}
        div[pagescroll=true]{height:900px;border-top:1px solid #ccc; position:relative;width:70%;overflow:hidden;margin:0 auto;}
        .anim{width:200px;height:300px;border:1px solid blue;position:absolute;visibility:hidden;}
        .left{left:200px;}
        .right{right:200px;}
       
    </style>
</head>
<body> 

    
    <div class="ps-wrap">

        <div class="content">500</div>
        
        <div pagescroll="true">
            <span>500</span>
            <div anim-id="1" class="anim left"></div>
            <div anim-id="2" class="anim right"></div>
        </div>
        
        <div pagescroll="true">
            <span>1100</span>
            <div anim-id="2" class="anim left"></div>
            <div anim-id="1" class="anim right"></div>
        </div>
        
        <div pagescroll="true">
            <span>1700</span>
            <div anim-id="1" class="anim left"></div>
        </div>
        
        <div pagescroll="true">
            <span>2300</span>
            <div  anim-id="1" class="anim left"></div>
            <div  anim-id="2" class="anim right"></div>
        </div>
        
        <div pagescroll="true">
            <span>2900</span>
            <div  anim-id="1" class="anim left"></div>
            <div  anim-id="2" class="anim right"></div>
        </div>
        
        <div pagescroll="true">
            <span>3500</span>
            <div  anim-id="1" class="anim left"></div>
            <div  anim-id="2" class="anim right"></div>
        </div>
        
    </div>

    <script type="text/javascript" src="./js/jquery-1.12.js"></script>
    <script type="text/javascript" src="./js/mlib.js"></script>
    <script>
       (function(win){
          
           var _pageScroll = function(wrapper, params){
                this.init(wrapper, params);
           }, 
           _win = $(win),
           _body = $('body'),
           _html = $('html'),
           _proto = _pageScroll.prototype,
           _wHeight = _win.height(),
           _ua = navigator.userAgent,
           _isMs = (_ua.search('Trident') > 0) || (_ua.search('Edge') > 0);
           
           _proto.init = function(wrapper, params){
                this._wrap = $(wrapper);
                this._blocks = $(wrapper).find('div[pagescroll=true]');
                this._params = params;
                this._bRef = _getBlocksRef(this._blocks);
                this._animEles = _getAnimEles(this._blocks);
                this._delayTimers = [];
                this.onscroll();
                this.onload();         
           };

           _proto._opts = {
                 

           }
           
           _proto.scroll = function(cback){
                var _this = this;
                _win.on('scroll', function(e){
                    cback.call(_this, e);
                });
           };
           
           _proto.load = function(cback){
                var _this = this;
                _win.on('load', function(e){
                    cback.call(_this, e); 
                });
            };
             
            _proto.onscroll = function(){
                this.scroll(function(e){
                    var sTop; 

                    if(_isMs){
                        sTop = _win.scrollTop();
                        this.toggleAnim(sTop);
                    }else{
                        sTop = _body.scrollTop();
                        this.toggleAnim(sTop);
                       
                    } 
                });
            }; 
           
            _proto.onload = function(){
                this.load(function(e){
                  var sTop;
                   
                   this.setAnim();
                   if(!_isMs){
                      sTop = _body.scrollTop()
                      this.toggleAnim(sTop);

                   }else{
                      sTop = _win.scrollTop();
                      this.toggleAnim(sTop);
                   } 
                   
                });
            };

            _proto.setAnim = function(){
              // console.log(this._params.anims);
              var _this = this,
                  anims = _this._params.anims;

              this._blocks.each(function(index){
                var eles = $(this).find('.anim'),
                    anim = anims[index];
               
                eles.each(function(){
                  var a_id = parseInt($(this).attr('anim-id')),
                      ele_anim = anim[a_id - 1];

                  $(this).attr('anim-type', ele_anim[0]);
                  $(this).attr('anim-duration', ele_anim[1]);
                  $(this).attr('anim-delay', ele_anim[2]);
                });
              });
            };

            _proto.toggleAnim = function(sTop){
              var ref = this._bRef,
                  _this = this,
                  anims = this._params.anims;
              if(this._delayTimers.length){
                $.each(this._delayTimers, function(index, item ){
                      clearTimeout(item);
                });
              }
              
              this._blocks.each(function(index, item){
                  var anim = anims[index],
                      animEles = _this._animEles[index];

                  if(sTop - ref[0][index] >= -_wHeight && 
                    sTop - ref[0][index] - ref[1][index] <= 0){
                    
                    _excAnim.call(_this, animEles, anim);

                  }else{
                    _removeAnim.call(_this, animEles, anim);
                  }    
                 
              });
            };

            function _getBlocksRef (blocks){
              var arr1 = blocks.map(function(index, item){
                          return $(this).offset().top;
                      }).get(),
                  arr2 = blocks.map(function(index, item){
                       return $(this).height();
                  }).get(),
                  arr3 = [];
                  arr3.push(arr1, arr2);

                  return arr3;
            }

            function _getAnimEles(blocks){
              return blocks.map(function(){
                        return $(this).find('.anim');
                    }).get();
            }

            function _excAnim(eles, anim){
                var _this = this;
                eles.each(function(){
                   var $this = $(this),
                      a_id = parseInt($(this).attr('anim-id')),
                      ele_anim = anim[a_id - 1];
                
                   $(this).css({
                      animationDuration: ele_anim[1] + 's'
                   });

                   _this._delayTimers.push(setTimeout(function(){
                       $this.addClass(ele_anim[0]);
                   }, ele_anim[2] * 1000));
                });  
            }

            function _removeAnim(eles, anim){
              eles.each(function(){
                 var $this = $(this),
                    a_id = parseInt($this.attr('anim-id')),
                    ele_anim = anim[a_id - 1];
                 $this.removeClass(ele_anim[0]);
              });
            }

            window.pageScroll = _pageScroll;

       })(window);

       $(function(){

          new pageScroll('.ps-wrap', {
            anims: [
              [['slideRight', 1, 0], ['slideLeft', 1, 0.2]],
              [['slideRight', 1, 0], ['slideLeft', 1, 0.2]],
              [['slideRight', 1, 0]],
              [['slideRight', 1, 0], ['slideLeft', 1, 0.2]],
              [['slideRight', 1, 0], ['slideLeft', 1, 0.2]],
              [['slideRight', 1, 0], ['slideLeft', 1, 0.2]]
            ]
          });
                
       });

       (function(win){
          function CArray(numElements){
            this.dataStore = [];
            this.pos = 0;
            this.numElements = numElements;
            for(var i = 0; i < numElements.length; ++i){
              this.dataStore[i] = i;
            }
          }

          CArray.prototype = {
            insert: insert,
            toString: toString,
            clear: clear,
            setData: setData,
            swap: swap
          }

          function setData(){
            for(var i = 0; i < this.numElements; ++i){
              this.dataStore[i] = Math.floor(Math.random() * (this.numElements + 1));
            }
          }

          function clear(){
            for(var i = 0; i < this.dataStore.length; ++i){
              this.dataStore[i] = 0;
            }
          }

          function insert(ele){
            this.dataStore[this.pos++] = ele;
          };

          function toString(){
            var restr = '';
            for(var i = 0; i < this.dataStore.length; ++i){
              restr += this.dataStore[i] + ', ';
              if(i > 0 & i % 10 == 0){
                restr += '\n';
              }
            }

            return restr;
          }

          function swap(arr, index1, index2){
            var temp = arr[index1];
            arr[index1] = arr[index2];
            arr[index2] = temp;
          }

          var numElements = 100;
          var myNums = new CArray(numElements);
          myNums.setData();
         

       })(window);


    </script>
</body>
</html>